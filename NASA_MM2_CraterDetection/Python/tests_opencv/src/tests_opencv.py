# To change this template, choose Tools | Templates
# and open the template in the editor.

from opencv.cv import *
from opencv.highgui import *
import sys
import glob
import re
import os

__author__="edemairy"
__date__ ="$Jun 16, 2011 11:28:24 AM$"


#root_dir = "/user/edemairy/home/Dropbox/Photos/training/A15/"
root_dirs = ["/user/edemairy/home/Dropbox/Photos/training/LRO/","/user/edemairy/home/Dropbox/Photos/training/A15/"]
#image_path = "/user/edemairy/home/Dropbox/Photos/training/A15/AS15-M-1005.lev1_sub4.tif"
# Structure of the point list: 
#   N : xl1 : yt1 : xr1 : yb1 : ... : xlN : ytN : xrN : ybN :
#   where N stands for the number of points, x{l|r} for left|right column, y{t|b} for top|bottom line.
#raw_points = "167 : 867 : 123 : 914 : 170 : 494 : 307 : 811 : 621 : 625 : 439 : 668 : 488 : 61 : 49 : 76 : 63 : 70 : 65 : 81 : 76 : 103 : 211 : 117 : 225 : 8 : 190 : 18 : 200 : 352 : 85 : 362 : 95 : 439 : 144 : 448 : 153 : 425 : 224 : 434 : 234 : 535 : 7 : 547 : 20 : 563 : 175 : 574 : 186 : 528 : 227 : 541 : 241 : 717 : 68 : 727 : 79 : 823 : 88 : 833 : 99 : 852 : 264 : 861 : 276 : 850 : 251 : 859 : 263 : 976 : 221 : 990 : 234 : 1016 : 54 : 1026 : 64 : 1064 : 42 : 1072 : 51 : 1030 : 283 : 1042 : 297 : 1306 : 27 : 1320 : 40 : 1228 : 53 : 1237 : 62 : 1333 : 167 : 1344 : 178 : 1389 : 197 : 1397 : 207 : 1346 : 263 : 1358 : 275 : 1338 : 273 : 1348 : 285 : 1284 : 300 : 1293 : 308 : 1240 : 441 : 1255 : 456 : 994 : 424 : 1009 : 439 : 998 : 410 : 1010 : 423 : 852 : 510 : 875 : 532 : 930 : 485 : 938 : 494 : 417 : 431 : 425 : 439 : 252 : 443 : 262 : 452 : 274 : 335 : 282 : 345 : 131 : 300 : 142 : 310 : 105 : 299 : 116 : 309 : 133 : 375 : 139 : 382 : 218 : 519 : 228 : 531 : 157 : 483 : 167 : 495 : 61 : 564 : 79 : 581 : 39 : 633 : 47 : 641 : 161 : 752 : 186 : 775 : 103 : 735 : 115 : 747 : 261 : 725 : 273 : 736 : 292 : 616 : 301 : 626 : 1061 : 763 : 1074 : 777 : 1013 : 775 : 1023 : 785 : 1014 : 719 : 1022 : 730 : 992 : 689 : 1001 : 698 : 1061 : 597 : 1069 : 605 : 1047 : 574 : 1059 : 587 : 1078 : 592 : 1088 : 600 : 1124 : 743 : 1135 : 754 : 1249 : 696 : 1256 : 704 : 1377 : 655 : 1401 : 674 : 1337 : 520 : 1344 : 529 : 1361 : 620 : 1370 : 629 : 1216 : 794 : 1230 : 810 : 1154 : 781 : 1162 : 790 : 1131 : 797 : 1141 : 807 : 1095 : 804 : 1105 : 813 : 1214 : 908 : 1227 : 922 : 1304 : 899 : 1312 : 908 : 1214 : 982 : 1222 : 992 : 1039 : 986 : 1052 : 998 : 1274 : 822 : 1279 : 829 : 759 : 844 : 772 : 859 : 783 : 895 : 791 : 903 : 760 : 885 : 769 : 893 : 599 : 761 : 608 : 769 : 472 : 823 : 492 : 844 : 458 : 849 : 467 : 858 : 381 : 902 : 393 : 914 : 330 : 963 : 366 : 996 : 396 : 974 : 412 : 989 : 396 : 992 : 411 : 1005 : 253 : 944 : 267 : 955 : 246 : 845 : 257 : 857 : 190 : 907 : 202 : 918 : 84 : 879 : 109 : 899 : 115 : 877 : 128 : 889 : 44 : 812 : 54 : 821 : 10 : 831 : 25 : 848 : 28 : 826 : 39 : 837 : 27 : 891 : 60 : 921 : 35 : 923 : 98 : 983 : 123 : 984 : 131 : 992 : 275 : 922 : 286 : 934 : 310 : 886 : 319 : 897 : 44 : 1082 : 59 : 1095 : 42 : 1110 : 53 : 1119 : 69 : 1091 : 80 : 1102 : 93 : 1069 : 98 : 1075 : 25 : 1038 : 42 : 1054 : 177 : 1139 : 196 : 1157 : 88 : 1194 : 116 : 1221 : 331 : 1148 : 352 : 1167 : 341 : 1126 : 349 : 1134 : 259 : 1087 : 270 : 1096 : 364 : 1074 : 377 : 1086 : 403 : 1057 : 414 : 1069 : 412 : 1018 : 424 : 1031 : 437 : 1073 : 444 : 1081 : 453 : 1030 : 461 : 1041 : 428 : 1156 : 438 : 1166 : 480 : 1142 : 489 : 1151 : 468 : 1181 : 485 : 1198 : 620 : 1180 : 633 : 1193 : 533 : 1188 : 542 : 1197 : 527 : 1209 : 534 : 1216 : 698 : 1067 : 710 : 1080 : 819 : 1161 : 830 : 1171 : 864 : 1135 : 872 : 1144 : 797 : 995 : 806 : 1004 : 451 : 972 : 457 : 978 : 463 : 1007 : 468 : 1013 : 998 : 1040 : 1007 : 1051 : 1008 : 1034 : 1016 : 1044 : 1016 : 1048 : 1021 : 1055 : 975 : 1054 : 981 : 1061 : 967 : 1075 : 973 : 1082 : 1102 : 1078 : 1108 : 1086 : 1109 : 1140 : 1117 : 1149 : 1151 : 1137 : 1158 : 1144 : 1069 : 1207 : 1074 : 1212 : 1077 : 1230 : 1084 : 1237 : 864 : 1183 : 870 : 1190 : 785 : 1229 : 791 : 1236 : 731 : 1230 : 739 : 1237 : 1178 : 1213 : 1185 : 1219 : 1336 : 1162 : 1341 : 1169 : 1366 : 1078 : 1375 : 1089 : 1336 : 1002 : 1347 : 1011 : 1372 : 1133 : 1377 : 1140 : 1380 : 1132 : 1388 : 1139 : 1409 : 1157 : 1418 : 1166 : 1316 : 1364 : 1325 : 1374 : 1279 : 1379 : 1290 : 1389 : 1241 : 1406 : 1253 : 1415 : 1141 : 1261 : 1163 : 1280 : 1103 : 1260 : 1115 : 1271 : 1039 : 1319 : 1047 : 1328 : 1023 : 1359 : 1031 : 1368 : 820 : 1277 : 831 : 1288 : 831 : 1260 : 838 : 1268 : 869 : 1265 : 876 : 1274 : 850 : 1338 : 856 : 1345 : 803 : 1290 : 812 : 1298 : 746 : 1286 : 753 : 1293 : 746 : 1253 : 751 : 1260 : 712 : 1277 : 718 : 1283 : 681 : 1283 : 689 : 1292 : 702 : 1341 : 712 : 1353 : 608 : 1286 : 614 : 1292 : 542 : 1408 : 557 : 1421 : 493 : 1332 : 504 : 1344 : 466 : 1292 : 477 : 1302 : 378 : 1381 : 389 : 1392 : 359 : 1372 : 371 : 1383 : 303 : 1258 : 313 : 1267 : 288 : 1301 : 295 : 1308 : 290 : 1369 : 300 : 1379 : 145 : 1324 : 154 : 1333 : 64 : 1281 : 74 : 1292 : 49 : 1341 : 61 : 1352 : "


if __name__ == "__main__":
    
    for root_dir in root_dirs:
        file_names = glob.glob(root_dir+"*.jpg")+glob.glob(root_dir+"*.tif")
        ground_truth = glob.glob(root_dir+"*.lms")
        for file_name in file_names:             
            name=os.path.split(file_name)[1]
            save_file_name = re.sub(re.compile(name), "GT_"+name, file_name)
            file = open(ground_truth[0], "r")
            result = re.compile(name+"(.*)").search(file.read())
            raw_points = result.group(1)
    
            image = cvLoadImage(file_name)
            split_points = raw_points.split(":")
            N = int(split_points[1])
            for i in range(0,N):
                point_offset = i*4+1
                xl = int(split_points[point_offset+1])
                yt = int(split_points[point_offset+2])
                xr = int(split_points[point_offset+3])
                yb = int(split_points[point_offset+4])            
                cvRectangle(image, cvPoint(xl,yt), cvPoint(xr,yb), (100,100,255), 2)
            result = cvSaveImage(save_file_name, image)
            print "sauvegarde de %s = %d" % (save_file_name, result)
    print "fini"
        
    
    